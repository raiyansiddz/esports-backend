# Makefile for eSports Fantasy Backend

# Variables
BINARY_NAME=esports-fantasy
BUILD_DIR=build
CMD_DIR=cmd/server

# Default target
.DEFAULT_GOAL := help

# Help target
help: ## Show this help message
	@echo "eSports Fantasy Backend - Available targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Build the application
build: ## Build the application binary
	@echo "ğŸ”¨ Building $(BINARY_NAME)..."
	@mkdir -p $(BUILD_DIR)
	@go build -o $(BUILD_DIR)/$(BINARY_NAME) $(CMD_DIR)/main.go
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME)"

# Run the application
run: ## Run the application
	@echo "ğŸš€ Starting $(BINARY_NAME)..."
	@go run $(CMD_DIR)/main.go

# Install dependencies
deps: ## Install/update dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	@go mod download
	@go mod tidy
	@echo "âœ… Dependencies installed"

# Clean build artifacts
clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)
	@echo "âœ… Clean complete"

# Run tests
test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	@go test -v ./...

# Run tests with coverage
test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running tests with coverage..."
	@go test -v -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report: coverage.html"

# Format code
fmt: ## Format code
	@echo "ğŸ¨ Formatting code..."
	@go fmt ./...
	@echo "âœ… Code formatted"

# Run linter
lint: ## Run linter
	@echo "ğŸ” Running linter..."
	@golangci-lint run
	@echo "âœ… Linting complete"

# Install tools
tools: ## Install development tools
	@echo "ğŸ”§ Installing development tools..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/swaggo/swag/cmd/swag@latest
	@echo "âœ… Tools installed"

# Generate swagger docs
swagger: ## Generate swagger documentation
	@echo "ğŸ“š Generating swagger documentation..."
	@swag init -g cmd/server/main.go -o api/docs
	@echo "âœ… Swagger docs generated"

# Run in development mode
dev: ## Run in development mode with auto-reload
	@echo "ğŸ”„ Starting in development mode..."
	@air

# Database migrations
migrate-up: ## Run database migrations up
	@echo "â¬†ï¸  Running database migrations..."
	@migrate -path migrations -database "$(DATABASE_URL)" up
	@echo "âœ… Migrations complete"

migrate-down: ## Run database migrations down
	@echo "â¬‡ï¸  Reverting database migrations..."
	@migrate -path migrations -database "$(DATABASE_URL)" down
	@echo "âœ… Migrations reverted"

# Docker targets
docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	@docker build -t $(BINARY_NAME) .
	@echo "âœ… Docker image built"

docker-run: ## Run Docker container
	@echo "ğŸ³ Running Docker container..."
	@docker run -p 8080:8080 --env-file .env $(BINARY_NAME)

# Development shortcuts
start: run ## Alias for run
dev-setup: deps tools ## Setup development environment
full-build: clean deps fmt test build ## Full build pipeline

.PHONY: help build run deps clean test test-coverage fmt lint tools swagger dev migrate-up migrate-down docker-build docker-run start dev-setup full-build